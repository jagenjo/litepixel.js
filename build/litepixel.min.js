'use strict';var global="undefined"!=typeof window?window:self,log=console.log.bind(console),LitePixel={last_uid:0,resources:{},generateUID:function(){return this.last_uid++}};Blend={NORMAL:0,ADD:1,MULTIPLY:2,SCREEN:3};function Sprite(a){this._ctor(a)}
Sprite.prototype._ctor=function(a){this.uid=LitePixel.generateUID();this.position=vec3.create();this.scale=vec2.fromValues(1,1);this.scroll_factor=vec2.fromValues(1,1);this.size=vec2.fromValues(0,0);this.color=vec4.fromValues(1,1,1,1);this.rotation=0;this._bounding=vec4.create();a&&(this.texture=a,this.size[0]=a.width,this.size[1]=a.height);this.flipX=!1;this.blendMode=Blend.NORMAL;this.spritesheet=!1;this.entities=[]};
Object.defineProperty(Sprite.prototype,"opacity",{get:function(){return this.color[3]},set:function(a){return this.color[3]=a}});Object.defineProperty(Sprite.prototype,"x",{get:function(){return this.position[0]},set:function(a){return this.position[0]=a}});Object.defineProperty(Sprite.prototype,"y",{get:function(){return this.position[1]},set:function(a){return this.position[1]=a}});
Object.defineProperty(Sprite.prototype,"z",{get:function(){return this.position[2]},set:function(a){return this.position[2]=a}});Sprite.prototype.configure=function(a){for(var b in a)this[b]&&this[b].constructor==Float32Array?this[b].set(a[b]):this[b]=a[b];a.src&&this.setImage(a.src)};Sprite.prototype.addChild=function(a){this.entities.push(a);a._stage=this._stage;a._parent=this};Sprite.prototype.useSpriteSheet=function(a,b){this.spritesheet=!0;this.frame_size=vec2.fromValues(a,b);this.frame=0};
Sprite.prototype.addAnimation=function(a,b){this.animations||(this.animations={});this.animations[a]=b;this.current_animation||(this.current_animation=b)};Sprite.prototype.playAnimation=function(a){this.current_animation!=a&&(this._current_frame=0);this.current_animation=a;this._anim=this.animations[a]};
Sprite.prototype.setImage=function(a){var b=this;(this.texture=LitePixel.resources[a])?(this.size[0]=this.texture.width,this.size[1]=this.texture.height):ResourcesManager.load(a,function(a,d){b.size[0]=d.width;b.size[1]=d.height;b.texture=d})};Sprite.fromImage=function(a){var b=new Sprite;b.setImage(a);return b};Sprite.prototype.propagate=function(a,b){for(var c in this.entities){var d=this.entities[c];d[a]&&d[a].apply(d,b);d.entities&&d.entities.length&&d.propagate(a,b)}};LitePixel.Sprite=Sprite;
function Sprite3D(){this._ctor();this._model_matrix=mat4.create()}Sprite3D.prototype.configure=function(a){Sprite.prototype.configure.call(this,a);this.two_sided=this.flip_normals=!0;this._mesh=GL.Mesh.cube({size:20})};Sprite3D.prototype.rotate=function(a,b){mat4.rotate(this._model_matrix,this._model_matrix,a*DEG2RAD,b)};
Sprite3D.prototype.render=function(a){this.texture&&this.texture.bind(0);a.getEntityMatrix(this,temp_mat4);mat4.multiply(temp_mat4,temp_mat4,this._model_matrix);a.checkBlending(this);mat4.multiply(a.mvp_matrix,a.vp_matrix,temp_mat4);a._uniforms.u_mvp=a.mvp_matrix;a._uniforms.u_color.set(this.color);this.two_sided?gl.disable(gl.CULL_FACE):gl.enable(gl.CULL_FACE);this.flip_normals&&gl.frontFace(gl.CW);gl.enable(gl.DEPTH_TEST);a.texture3d_shader.uniforms(a._uniforms).draw(this._mesh);this.flip_normals&&
gl.frontFace(gl.CCW);this.two_sided&&gl.enable(gl.CULL_FACE);this._stage.depth_test?gl.enable(gl.DEPTH_TEST):gl.disable(gl.DEPTH_TEST);gl.disable(gl.CULL_FACE)};extendClass(Sprite3D,Sprite);function Particles(){this._ctor();this.max=100;this.particles=[]}Particles.prototype.render=function(a){this._mesh||this.createMesh()};
Particles.prototype.createMesh=function(){var a=new Float32Array(2*this.max),b=new Float32Array(2*this.max),c=new GL.Mesh;c.addBuffer("vertices2D",null,0,a,gl.STREAM_DRAW);c.addBuffer("extra2",null,0,b,gl.STREAM_DRAW);this._mesh=c};Particles.prototype.updateMesh=function(a){if(this.mesh)for(var b in this.particles);};Particles.prototype.update=function(a){this.updateMesh()};extendClass(Particles,Sprite);
function Stage(a){this.bgcolor=vec4.fromValues(0,0,0,1);this.time=0;this.depth_test=!1;a?this.bgcolor.set(a):null===a&&(this.bgcolor=null);this.entities=[]}Stage.prototype.addChild=function(a){this.entities.push(a);a._stage=this};Stage.prototype.getEntity=function(a){for(var b=0;b<this.entities.length;++b)if(this.entities[b].id==a)return this.entities[b];return null};Stage.prototype.getEntitiesAtPos=function(a,b,c){for(a=0;a<this.entities.length;++a);};
Stage.prototype.query=function(a){return new Query(a,this)};Stage.prototype.update=function(a){this.propagate("update",[a,this.time]);this.time+=a};Stage.prototype.propagate=Sprite.prototype.propagate;
Stage.prototype.load=function(a,b){var c=this;ResourcesManager.loadFile(a,function(a,h){var e=null,k=h.split("\n"),l;for(l in k){var g=k[l].trim();if(g&&"#"!=g[0]){var m=g.indexOf(" "),f=g.slice(0,m),g=g.slice(m+1);switch(f){case "layer":e=new Sprite;e.id=g;c.addChild(e);break;case "sprite":f=new Sprite;h=eval("("+g+")");f.configure(h);(e||c).addChild(f);break;default:global[f]&&(f=new global[f],h=eval("("+g+")"),f.configure&&f.configure(h),(e||c).addChild(f))}}}b&&b()})};LitePixel.Stage=Stage;
function Query(a,b){this.result=[];for(var c in b.entities){var d=b.entities[c];"."==a[0]&&d.className==a.substr(1)&&this.result.push(d)}}Query.prototype.action=function(a){this.result.forEach(a)};function Camera(){this.position=vec2.create();this.scale=1;this.bounds=vec4.create();this.max_scale=10;this.min_scale=0.1;this.focal_distance=0}Camera.prototype.setBounds=function(a,b,c,d){this.bounds[0]=a;this.bounds[1]=b;this.bounds[2]=c;this.bounds[3]=d};
Camera.prototype.canvasToStage=function(a,b,c){c||vec2.create()};Camera.prototype.setZoom=function(a,b,c,d){void 0===b&&(b=d?0.5*d.width:0);void 0===c&&(c=d?0.5*d.height:0);d=this.convertCanvasToStage(b,c);this.scale=a;this.scale>this.max_scale?this.scale=this.max_scale:this.scale<this.min_scale&&(this.scale=this.min_scale);a=this.convertCanvasToStage(b,c);this.position[0]-=a[0]-d[0];this.position[1]-=a[1]-d[1]};
Camera.prototype.centerIn=function(a,b){this.position[0]=a.position[0]-0.5*b.width/this.scale;this.position[1]=a.position[1]-0.5*b.height/this.scale};Camera.prototype.convertStageToCanvas=function(a,b,c){c=c||vec2.create();c[0]=(a-this.position[0])*this.scale;c[1]=(b-this.position[1])*this.scale;return c};Camera.prototype.convertCanvasToStage=function(a,b,c){c=c||vec2.create();c[0]=this.position[0]+a/this.scale;c[1]=this.position[1]+b/this.scale;return c};
var temp_mat4=mat4.create(),temp_vec2=vec3.create(),temp_vec3=vec3.create(),temp_vec4=vec3.create();
function Renderer(a,b,c){c&&"string"==typeof c&&(c=document.querySelector(c));Renderer._instance=this;this.premultiply_alpha=this.smoothing=!0;a=GL.create({width:a,height:b,alpha:!1,canvas:c});this.canvas=a.canvas;a.captureMouse(!0);a.captureKeys(!0);this.context=a;LitePixel.last_canvas=this.canvas;this.view_matrix=mat4.create();this.proj_matrix=mat4.create();this.vp_matrix=mat4.create();this.mvp_matrix=mat4.create();this.tex_matrix=mat3.create();this.matrix_stack=new Float32Array(256);this.stack_top=
this.matrix_stack.subarray(0,16);mat4.identity(this.stack_top);this.offset=vec2.create();this.scale=1;this.round_offset=!0;mat4.ortho(this.proj_matrix,0,a.canvas.width,0,a.canvas.height,-100,100);mat4.multiply(this.vp_matrix,this.proj_matrix,this.view_matrix);this.ambient_color=vec4.fromValues(1,1,1,1);this._uniforms={u_mvp:this.vp_matrix,u_color:this.ambient_color,u_texmatrix:this.tex_matrix,u_texture:0};this.current_texture=null;this.plane_mesh=GL.Mesh.plane2D({size:1});this.texture_shader=new Shader("\t\t\tprecision highp float;\t\t\tattribute vec2 a_vertex2D;\t\t\tattribute vec2 a_coord;\t\t\tvarying vec2 v_coord;\t\t\tuniform mat3 u_texmatrix;\t\t\tuniform mat4 u_mvp;\t\t\tvoid main() {\t\t\t\tv_coord = (u_texmatrix * vec3(a_coord,1.0)).xy;\t\t\t\tgl_Position = u_mvp * vec4(a_vertex2D,0.0,1.0);\t\t\t}\t\t\t",
"\t\t\tprecision highp float;\t\t\tvarying vec2 v_coord;\t\t\tuniform sampler2D u_texture;\t\t\tuniform vec4 u_color;\t\t\tvoid main() {\t\t\t   vec4 color = u_color * texture2D(u_texture, v_coord);\t\t\t   if(color.a < 0.01) \t\t\t\t\tdiscard; \t\t\t   gl_FragColor = color;\t\t\t}\t\t");this.texture3d_shader=new Shader("\t\t\tprecision highp float;\t\t\tattribute vec3 a_vertex;\t\t\tattribute vec2 a_coord;\t\t\tvarying vec2 v_coord;\t\t\tuniform mat3 u_texmatrix;\t\t\tuniform mat4 u_mvp;\t\t\tvoid main() {\t\t\t\tv_coord = (u_texmatrix * vec3(a_coord,1.0)).xy;\t\t\t\tgl_Position = u_mvp * vec4(a_vertex,1.0);\t\t\t}\t\t\t",
"\t\t\tprecision highp float;\t\t\tvarying vec2 v_coord;\t\t\tuniform sampler2D u_texture;\t\t\tuniform vec4 u_color;\t\t\tvoid main() {\t\t\t   vec4 color = u_color * texture2D(u_texture, v_coord);\t\t\t   if(color.a < 0.01) \t\t\t\t\tdiscard; \t\t\t   gl_FragColor = color;\t\t\t}\t\t")}Renderer._instance=null;
Renderer.prototype.render=function(a,b){this.computeCameraMatrices(b);this.current_texture=null;a.bgcolor&&(gl.clearColor(a.bgcolor[0],a.bgcolor[1],a.bgcolor[2],a.bgcolor[3]),gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT));gl.depthFunc(gl.LEQUAL);gl[a.depth_test?"enable":"disable"](gl.DEPTH_TEST);gl.disable(gl.CULL_FACE);gl.enable(gl.BLEND);gl.blendFunc(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA);a.entities.forEach(this.renderEntity.bind(this))};
Renderer.prototype.computeCameraMatrices=function(a){if(a)if(this.offset.set(a.position),this.scale=a.scale,a.focal_distance){var b=2*Math.atan(this.canvas.height/(2*a.focal_distance));mat4.perspective(this.proj_matrix,b,this.canvas.width/this.canvas.height,0.01,2*a.focal_distance);mat4.lookAt(this.view_matrix,[0.5*this.canvas.width,0.5*this.canvas.height,a.focal_distance],[0.5*this.canvas.width,0.5*this.canvas.height,0],[0,1,0])}else mat4.identity(this.view_matrix),mat4.ortho(this.proj_matrix,0,
this.canvas.width,0,this.canvas.height,-100,100);else this.offset[0]=this.offset[1]=0,this.scale=1,mat4.identity(this.view_matrix),mat4.ortho(this.proj_matrix,0,this.canvas.width,0,this.canvas.height,-1,1);mat4.multiply(this.vp_matrix,this.proj_matrix,this.view_matrix)};Renderer.prototype.renderEntity=function(a){if(a.render)return a.render(this);if(a.texture||a.entities.length)this.getEntityMatrix(a,temp_mat4),a.texture&&this.renderSprite(temp_mat4,a),a.entities&&a.entities.forEach(this.renderEntity.bind(this))};
Renderer.prototype.getEntityMatrix=function(a,b){mat4.identity(b);var c=this.offset[0],d=this.offset[1];this.round_offset&&(c=Math.round(c),d=Math.round(d));temp_vec3[0]=(a.position[0]-c*a.scroll_factor[0])*this.scale;temp_vec3[1]=(a.position[1]-d*a.scroll_factor[0])*this.scale;temp_vec3[2]=a.position[2];mat4.translate(b,b,temp_vec3);mat4.rotateZ(b,b,a.rotation*DEG2RAD);temp_vec3[0]=a.scale[0]*this.scale;temp_vec3[1]=a.scale[1]*this.scale;temp_vec3[2]=a.scale[0];mat4.scale(b,b,temp_vec3)};
Renderer.prototype.checkBlending=function(a){switch(a.blendMode){case 1:gl.blendFunc(gl.SRC_ALPHA,gl.ONE);break;case 2:gl.blendFunc(gl.DST_COLOR,gl.ONE_MINUS_SRC_ALPHA);break;case 3:gl.blendFunc(gl.SRC_ALPHA,gl.ONE);break;default:gl.blendFunc(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA)}};
Renderer.prototype.renderSprite=function(a,b){var c=b.texture.width,d=b.texture.height;b.spritesheet&&(c=b.frame_size[0],d=b.frame_size[1]);temp_vec3[0]=c;temp_vec3[1]=d;b.flipX&&(temp_vec3[0]*=-1);mat4.scale(temp_mat4,temp_mat4,temp_vec3);mat4.multiply(this.mvp_matrix,this.vp_matrix,temp_mat4);this._uniforms.u_mvp=this.mvp_matrix;this._uniforms.u_color.set(b.color);this.current_texture!=b.texture&&(b.texture.bind(0),this.current_texture=b.texture);this.checkBlending(b);b.no_depth_write&&gl.depthMask(!1);
if(b.spritesheet){mat3.identity(this.tex_matrix);var h=b.texture.width/b.frame_size[0],e=b._anim,e=e[(b._current_frame|0)%e.length];temp_vec2[0]=e%h*c/b.texture.width;temp_vec2[1]=e/h|0*d/b.texture.height;mat3.translate(this.tex_matrix,this.tex_matrix,temp_vec2);temp_vec2[0]=c/b.texture.width;temp_vec2[1]=d/b.texture.height;mat3.scale(this.tex_matrix,this.tex_matrix,temp_vec2);this.texture_shader.uniforms(this._uniforms).draw(this.plane_mesh);mat3.identity(this.tex_matrix)}else this.texture_shader.uniforms(this._uniforms).draw(this.plane_mesh);
b.no_depth_write&&gl.depthMask(!0)};LitePixel.Renderer=Renderer;
ResourcesManager={path:"",_loading:{},_num_loading:0,load:function(a,b){a.constructor==String&&(a=[a]);var c=a.length,d;for(d in a)this.loadFile(a[d],function(a,d){c--;0==c&&b&&b(a,d)})},loadFile:function(a,b){if(null!=LitePixel.resources[a])return b&&b(a,LitePixel.resources[a]),!0;if(!this.getExtension(a))return!1;if(null!=this._loading[a])this._loading[a].push({callback:b});else{this._loading[a]=[{callback:b}];0==this._num_loading&&LEvent.trigger(this,"start_loading_resources",a);this._num_loading++;
var c=this.getExtension(a);if("jpg"==c||"png"==c)return c=new Image,c.src=this.path+a,c.onload=function(b){b={};Renderer._instance.premultiply_alpha&&(b.premultiply_alpha=!0);isPowerOfTwo(this.width)&&isPowerOfTwo(this.height)||(b={wrapS:gl.CLAMP_TO_EDGE,wrapT:gl.CLAMP_TO_EDGE,minFilter:gl.LINEAR,magFilter:gl.LINEAR});Renderer._instance.smoothing||(b.magFilter=gl.NEAREST);b=GL.Texture.fromImage(this,b);LitePixel.resources[a]=b;LitePixel.ResourcesManager.triggerResourceLoaded(a,b)},c.onerror=function(b){console.error(b);
LitePixel.ResourcesManager.triggerResourceLoaded(a,null)},c;c=new XMLHttpRequest;c.open("GET",this.path+a,!0);c.onload=function(b){if(200!=this.status)console.error("Error "+this.status);else{var c=this.response;LitePixel.resources[a]=c}LitePixel.ResourcesManager.triggerResourceLoaded(a,c)};c.send();return c}},triggerResourceLoaded:function(a,b){this._num_loading--;if(this._loading[a]){for(var c in this._loading[a])null!=this._loading[a][c].callback&&this._loading[a][c].callback(a,b);delete this._loading[a];
0==this._num_loading&&LEvent.trigger(this,"end_loading_resources")}},getExtension:function(a){var b=a.indexOf("?");-1!=b&&(a=a.substr(0,b));b=a.lastIndexOf(".");return-1==b?"":a.substr(b+1).toLowerCase()}};LitePixel.ResourcesManager=ResourcesManager;function componentToHex(a){a=a.toString(16);return 1==a.length?"0"+a:a}function rgbToHex(a,b,c){return""+componentToHex(a)+componentToHex(b)+componentToHex(c)}
function hexToRgbNumber(a){return(a=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(a))?{r:parseInt(a[1],16),g:parseInt(a[2],16),b:parseInt(a[3],16)}:null}function hexToRgb(a){};
